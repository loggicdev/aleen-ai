# ========================================
# TRIAL TOOLS - Para Interação Conversacional
# ========================================

from typing import Dict, Optional
import os
import json
import subprocess

# Importar Supabase corretamente para evitar circular import
def get_supabase_client():
    try:
        from src.services.supabase_service import supabase_service
        return supabase_service.get_client()
    except ImportError:
        try:
            from services.supabase_service import supabase_service
            return supabase_service.get_client()
        except ImportError:
            print("⚠️ SupabaseService não disponível")
            return None

def check_user_trial_status(user_id: str) -> Dict:
    """
    Verifica status do trial do usuário para IA poder decidir ação
    
    Args:
        user_id: ID do usuário
        
    Returns:
        Dict com informações do status:
        - has_subscription: bool
        - subscription_status: str
        - onboarding_complete: bool  
        - has_pending_checkout: bool
        - checkout_url: str (se existe)
        - needs_trial: bool
        - error: str (se erro)
    """
    try:
        supabase = get_supabase_client()
        if not supabase:
            return {"error": "Serviço de banco não disponível"}
        
        print(f"🔧 TOOL: Verificando acesso para usuário {user_id}")
        
        # Verificar usuário
        user_data = supabase.table('users')\
            .select('email, name, onboarding, stripe_customer_id')\
            .eq('id', user_id)\
            .single()\
            .execute()
        
        if not user_data.data:
            return {
                "error": "Usuário não encontrado",
                "has_subscription": False,
                "needs_trial": False
            }
        
        onboarding_complete = user_data.data.get('onboarding', False)
        
        if not onboarding_complete:
            return {
                "has_subscription": False,
                "onboarding_complete": False,
                "needs_trial": False,
                "error": "Onboarding não completado"
            }
        
        # Verificar subscription ativa
        subscription_data = supabase.table('subscriptions')\
            .select('status, stripe_subscription_id')\
            .eq('user_id', user_id)\
            .eq('status', 'active')\
            .execute()
        
        if subscription_data.data and len(subscription_data.data) > 0:
            return {
                "has_subscription": True,
                "subscription_status": "active",
                "onboarding_complete": True,
                "needs_trial": False
            }
        
        # Verificar checkout pendente
        checkout_data = supabase.table('checkout_sessions')\
            .select('checkout_url, stripe_checkout_session_id, status')\
            .eq('user_id', user_id)\
            .eq('status', 'pending')\
            .order('created_at', desc=True)\
            .limit(1)\
            .execute()
        
        has_pending_checkout = bool(checkout_data.data and len(checkout_data.data) > 0)
        checkout_url = checkout_data.data[0]['checkout_url'] if has_pending_checkout else None
        
        return {
            "has_subscription": False,
            "subscription_status": "none",
            "onboarding_complete": True,
            "has_pending_checkout": has_pending_checkout,
            "checkout_url": checkout_url,
            "needs_trial": True
        }
        
    except Exception as e:
        return {
            "error": f"Erro ao verificar status: {str(e)}",
            "has_subscription": False,
            "needs_trial": False
        }

def create_trial_checkout(user_id: str) -> Dict:
    """
    Cria checkout session para trial após confirmação do usuário
    
    Args:
        user_id: ID do usuário
        
    Returns:
        Dict com resultado:
        - success: bool
        - checkout_url: str (se sucesso)
        - message: str
        - error: str (se erro)
    """
    try:
        supabase_service = get_supabase_service()
        if not supabase_service:
            return {"success": False, "error": "Serviço de banco não disponível"}
        
        # Verificar se usuário existe e onboarding completo
        user_data = supabase_service.table('users')
            .select('email, name, onboarding, stripe_customer_id')
            .eq('id', user_id)
            .single()
            .execute()

# Funções que serão chamadas pela IA
def tool_check_trial_status(user_id: str) -> str:
    """Tool para IA verificar status do trial do usuário"""
    result = check_user_trial_status(user_id)
    
    if result.get("error"):
        return f"❌ Erro: {result['error']}"
    
    if result.get("has_subscription"):
        return "✅ Usuário já possui assinatura ativa"
    
    if not result.get("onboarding_complete"):
        return "⚠️ Usuário precisa completar onboarding primeiro"
    
    if result.get("has_pending_checkout"):
        return f"⏳ Usuário já tem checkout pendente: {result.get('checkout_url')}"
    
    if result.get("needs_trial"):
        return "🎁 Usuário elegível para trial de 14 dias gratuito"
    
    return "ℹ️ Status indefinido"

def tool_create_trial_checkout(user_id: str) -> str:
    """Tool para IA criar checkout após confirmação do usuário"""
    result = create_trial_checkout(user_id)
    
    if result.get("success"):
        checkout_url = result.get("checkout_url")
        return f"""✅ Checkout criado com sucesso!

🔗 **Link para começar seu trial gratuito:**
{checkout_url}

🎁 **Você terá 14 dias completamente grátis para testar todos os recursos da Aleen IA!**

✅ **Benefícios inclusos:**
- Planos de nutrição personalizados
- Treinos específicos para seu objetivo  
- Suporte 24/7 da Aleen
- Acesso a todos os recursos premium

💳 *Após inserir os dados do cartão, você terá 14 dias para testar tudo gratuitamente antes de qualquer cobrança!*"""
    else:
        error = result.get("error", "Erro desconhecido")
        return f"❌ Não foi possível criar o checkout: {error}"

# Ferramentas da IA no formato correto
def get_trial_tools():
    """
    Retorna as ferramentas de trial para a IA usar
    """
    return [
        {
            "name": "check_user_trial_status",
            "description": "Verifica o status do trial/assinatura do usuário atual",
            "parameters": {
                "type": "object",
                "properties": {},
                "required": []
            }
        },
        {
            "name": "create_trial_checkout", 
            "description": "Cria link de pagamento para iniciar trial de 14 dias APENAS após o usuário confirmar que deseja",
            "parameters": {
                "type": "object",
                "properties": {
                    "user_confirmed": {
                        "type": "boolean",
                        "description": "Se o usuário confirmou que deseja iniciar o trial"
                    }
                },
                "required": ["user_confirmed"]
            }
        }
    ]

# Lista de tools disponíveis
TRIAL_TOOLS = get_trial_tools()
